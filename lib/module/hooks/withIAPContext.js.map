{"version":3,"names":["React","useContext","useEffect","useMemo","useState","promotedProductListener","purchaseErrorListener","purchaseUpdatedListener","transactionListener","IapIos","initConnection","IAPContext","createContext","useIAPContext","ctx","Error","withIAPContext","Component","WrapperComponent","props","connected","setConnected","products","setProducts","promotedProductsIOS","setPromotedProductsIOS","subscriptions","setSubscriptions","purchaseHistory","setPurchaseHistory","availablePurchases","setAvailablePurchases","currentPurchase","setCurrentPurchase","currentTransaction","setCurrentTransaction","currentPurchaseError","setCurrentPurchaseError","initConnectionError","setInitConnectionError","context","then","value","undefined","catch","purchaseUpdateSubscription","purchase","transactionUpdateSubscription","transactionOrError","error","transaction","purchaseErrorSubscription","promotedProductSubscription","product","getPromotedProductIOS","prevProducts","remove"],"sources":["withIAPContext.tsx"],"sourcesContent":["import React, {useContext, useEffect, useMemo, useState} from 'react';\n\nimport {\n  promotedProductListener,\n  purchaseErrorListener,\n  purchaseUpdatedListener,\n  transactionListener,\n} from '../eventEmitter';\nimport {IapIos, initConnection} from '../iap';\nimport type {PurchaseError} from '../purchaseError';\nimport type {\n  Product,\n  ProductPurchase,\n  Purchase,\n  Subscription,\n  SubscriptionPurchase,\n} from '../types';\nimport type {TransactionEvent, TransactionSk2} from '../types/appleSk2';\n\ntype IAPContextType = {\n  connected: boolean;\n  products: Product[];\n  promotedProductsIOS: Product[];\n  subscriptions: Subscription[];\n  purchaseHistory: Purchase[];\n  availablePurchases: Purchase[];\n  currentPurchase?: Purchase;\n  currentTransaction?: TransactionSk2;\n  currentPurchaseError?: PurchaseError;\n  initConnectionError?: Error;\n  setProducts: (products: Product[]) => void;\n  setSubscriptions: (subscriptions: Subscription[]) => void;\n  setPurchaseHistory: (purchaseHistory: Purchase[]) => void;\n  setAvailablePurchases: (availablePurchases: Purchase[]) => void;\n  setCurrentPurchase: (currentPurchase: Purchase | undefined) => void;\n  setCurrentPurchaseError: (\n    currentPurchaseError: PurchaseError | undefined,\n  ) => void;\n};\n\n// @ts-ignore\nconst IAPContext = React.createContext<IAPContextType>(null);\n\nexport function useIAPContext(): IAPContextType {\n  const ctx = useContext(IAPContext);\n\n  if (!ctx) {\n    throw new Error('You need wrap your app with withIAPContext HOC');\n  }\n\n  return ctx;\n}\n\nexport function withIAPContext<T>(Component: React.ComponentType<T>) {\n  return function WrapperComponent(props: T) {\n    const [connected, setConnected] = useState(false);\n    const [products, setProducts] = useState<Product[]>([]);\n\n    const [promotedProductsIOS, setPromotedProductsIOS] = useState<Product[]>(\n      [],\n    );\n    const [subscriptions, setSubscriptions] = useState<Subscription[]>([]);\n    const [purchaseHistory, setPurchaseHistory] = useState<Purchase[]>([]);\n\n    const [availablePurchases, setAvailablePurchases] = useState<Purchase[]>(\n      [],\n    );\n    const [currentPurchase, setCurrentPurchase] = useState<Purchase>();\n    const [currentTransaction, setCurrentTransaction] =\n      useState<TransactionSk2>();\n\n    const [currentPurchaseError, setCurrentPurchaseError] =\n      useState<PurchaseError>();\n\n    const [initConnectionError, setInitConnectionError] = useState<Error>();\n\n    const context = useMemo(\n      () => ({\n        connected,\n        products,\n        subscriptions,\n        promotedProductsIOS,\n        purchaseHistory,\n        availablePurchases,\n        currentPurchase,\n        currentTransaction,\n        currentPurchaseError,\n        initConnectionError,\n        setProducts,\n        setSubscriptions,\n        setPurchaseHistory,\n        setAvailablePurchases,\n        setCurrentPurchase,\n        setCurrentPurchaseError,\n      }),\n      [\n        connected,\n        products,\n        subscriptions,\n        promotedProductsIOS,\n        purchaseHistory,\n        availablePurchases,\n        currentPurchase,\n        currentTransaction,\n        currentPurchaseError,\n        initConnectionError,\n        setProducts,\n        setSubscriptions,\n        setPurchaseHistory,\n        setAvailablePurchases,\n        setCurrentPurchase,\n        setCurrentPurchaseError,\n      ],\n    );\n\n    useEffect(() => {\n      initConnection()\n        .then((value) => {\n          setInitConnectionError(undefined);\n          setConnected(value);\n        })\n        .catch(setInitConnectionError);\n    }, []);\n\n    useEffect(() => {\n      if (!connected) {\n        return;\n      }\n\n      const purchaseUpdateSubscription = purchaseUpdatedListener(\n        async (purchase: ProductPurchase | SubscriptionPurchase) => {\n          setCurrentPurchaseError(undefined);\n          setCurrentPurchase(purchase);\n        },\n      );\n\n      const transactionUpdateSubscription = transactionListener(\n        async (transactionOrError: TransactionEvent) => {\n          setCurrentPurchaseError(transactionOrError?.error);\n          setCurrentTransaction(transactionOrError?.transaction);\n        },\n      );\n\n      const purchaseErrorSubscription = purchaseErrorListener(\n        (error: PurchaseError) => {\n          setCurrentPurchase(undefined);\n          setCurrentPurchaseError(error);\n        },\n      );\n\n      const promotedProductSubscription = promotedProductListener(async () => {\n        const product = await IapIos.getPromotedProductIOS();\n\n        setPromotedProductsIOS((prevProducts) => [\n          ...prevProducts,\n          ...(product ? [product] : []),\n        ]);\n      });\n\n      return () => {\n        purchaseUpdateSubscription.remove();\n        purchaseErrorSubscription.remove();\n        promotedProductSubscription?.remove();\n        transactionUpdateSubscription?.remove();\n      };\n    }, [connected]);\n\n    return (\n      <IAPContext.Provider value={context}>\n        <Component {...props} />\n      </IAPContext.Provider>\n    );\n  };\n}\n"],"mappings":"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"}