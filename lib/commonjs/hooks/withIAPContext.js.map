{"version":3,"names":["IAPContext","React","createContext","useIAPContext","ctx","useContext","Error","withIAPContext","Component","WrapperComponent","props","connected","setConnected","useState","products","setProducts","promotedProductsIOS","setPromotedProductsIOS","subscriptions","setSubscriptions","purchaseHistory","setPurchaseHistory","availablePurchases","setAvailablePurchases","currentPurchase","setCurrentPurchase","currentTransaction","setCurrentTransaction","currentPurchaseError","setCurrentPurchaseError","initConnectionError","setInitConnectionError","context","useMemo","useEffect","initConnection","then","value","undefined","catch","purchaseUpdateSubscription","purchaseUpdatedListener","purchase","transactionUpdateSubscription","transactionListener","transactionOrError","error","transaction","purchaseErrorSubscription","purchaseErrorListener","promotedProductSubscription","promotedProductListener","product","IapIos","getPromotedProductIOS","prevProducts","remove"],"sources":["withIAPContext.tsx"],"sourcesContent":["import React, {useContext, useEffect, useMemo, useState} from 'react';\n\nimport {\n  promotedProductListener,\n  purchaseErrorListener,\n  purchaseUpdatedListener,\n  transactionListener,\n} from '../eventEmitter';\nimport {IapIos, initConnection} from '../iap';\nimport type {PurchaseError} from '../purchaseError';\nimport type {\n  Product,\n  ProductPurchase,\n  Purchase,\n  Subscription,\n  SubscriptionPurchase,\n} from '../types';\nimport type {TransactionEvent, TransactionSk2} from '../types/appleSk2';\n\ntype IAPContextType = {\n  connected: boolean;\n  products: Product[];\n  promotedProductsIOS: Product[];\n  subscriptions: Subscription[];\n  purchaseHistory: Purchase[];\n  availablePurchases: Purchase[];\n  currentPurchase?: Purchase;\n  currentTransaction?: TransactionSk2;\n  currentPurchaseError?: PurchaseError;\n  initConnectionError?: Error;\n  setProducts: (products: Product[]) => void;\n  setSubscriptions: (subscriptions: Subscription[]) => void;\n  setPurchaseHistory: (purchaseHistory: Purchase[]) => void;\n  setAvailablePurchases: (availablePurchases: Purchase[]) => void;\n  setCurrentPurchase: (currentPurchase: Purchase | undefined) => void;\n  setCurrentPurchaseError: (\n    currentPurchaseError: PurchaseError | undefined,\n  ) => void;\n};\n\n// @ts-ignore\nconst IAPContext = React.createContext<IAPContextType>(null);\n\nexport function useIAPContext(): IAPContextType {\n  const ctx = useContext(IAPContext);\n\n  if (!ctx) {\n    throw new Error('You need wrap your app with withIAPContext HOC');\n  }\n\n  return ctx;\n}\n\nexport function withIAPContext<T>(Component: React.ComponentType<T>) {\n  return function WrapperComponent(props: T) {\n    const [connected, setConnected] = useState(false);\n    const [products, setProducts] = useState<Product[]>([]);\n\n    const [promotedProductsIOS, setPromotedProductsIOS] = useState<Product[]>(\n      [],\n    );\n    const [subscriptions, setSubscriptions] = useState<Subscription[]>([]);\n    const [purchaseHistory, setPurchaseHistory] = useState<Purchase[]>([]);\n\n    const [availablePurchases, setAvailablePurchases] = useState<Purchase[]>(\n      [],\n    );\n    const [currentPurchase, setCurrentPurchase] = useState<Purchase>();\n    const [currentTransaction, setCurrentTransaction] =\n      useState<TransactionSk2>();\n\n    const [currentPurchaseError, setCurrentPurchaseError] =\n      useState<PurchaseError>();\n\n    const [initConnectionError, setInitConnectionError] = useState<Error>();\n\n    const context = useMemo(\n      () => ({\n        connected,\n        products,\n        subscriptions,\n        promotedProductsIOS,\n        purchaseHistory,\n        availablePurchases,\n        currentPurchase,\n        currentTransaction,\n        currentPurchaseError,\n        initConnectionError,\n        setProducts,\n        setSubscriptions,\n        setPurchaseHistory,\n        setAvailablePurchases,\n        setCurrentPurchase,\n        setCurrentPurchaseError,\n      }),\n      [\n        connected,\n        products,\n        subscriptions,\n        promotedProductsIOS,\n        purchaseHistory,\n        availablePurchases,\n        currentPurchase,\n        currentTransaction,\n        currentPurchaseError,\n        initConnectionError,\n        setProducts,\n        setSubscriptions,\n        setPurchaseHistory,\n        setAvailablePurchases,\n        setCurrentPurchase,\n        setCurrentPurchaseError,\n      ],\n    );\n\n    useEffect(() => {\n      initConnection()\n        .then((value) => {\n          setInitConnectionError(undefined);\n          setConnected(value);\n        })\n        .catch(setInitConnectionError);\n    }, []);\n\n    useEffect(() => {\n      if (!connected) {\n        return;\n      }\n\n      const purchaseUpdateSubscription = purchaseUpdatedListener(\n        async (purchase: ProductPurchase | SubscriptionPurchase) => {\n          setCurrentPurchaseError(undefined);\n          setCurrentPurchase(purchase);\n        },\n      );\n\n      const transactionUpdateSubscription = transactionListener(\n        async (transactionOrError: TransactionEvent) => {\n          setCurrentPurchaseError(transactionOrError?.error);\n          setCurrentTransaction(transactionOrError?.transaction);\n        },\n      );\n\n      const purchaseErrorSubscription = purchaseErrorListener(\n        (error: PurchaseError) => {\n          setCurrentPurchase(undefined);\n          setCurrentPurchaseError(error);\n        },\n      );\n\n      const promotedProductSubscription = promotedProductListener(async () => {\n        const product = await IapIos.getPromotedProductIOS();\n\n        setPromotedProductsIOS((prevProducts) => [\n          ...prevProducts,\n          ...(product ? [product] : []),\n        ]);\n      });\n\n      return () => {\n        purchaseUpdateSubscription.remove();\n        purchaseErrorSubscription.remove();\n        promotedProductSubscription?.remove();\n        transactionUpdateSubscription?.remove();\n      };\n    }, [connected]);\n\n    return (\n      <IAPContext.Provider value={context}>\n        <Component {...props} />\n      </IAPContext.Provider>\n    );\n  };\n}\n"],"mappings":"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"}